# 第五章 HTTP的几种连接

HTTP是一个应用层协议，基于TCP/IP。HTTP的连接其实就是TCP连接，从头到尾都是。只不过在其中传递的数据包不是任意的二进制，而是HTTP规定好的数据包。数据的发送也不是任意的，而是一个请求一个响应（请求和响应一对构成一个事务）。

我们关心连接的使用方式，是因为它事关多事务情况下的性能。而在http中，处理多事务的连接有4种方式：

1. 并行连接
2. Keep-Alive
3. 持久连接
4. 管线\(pipeline\)。

我们拿一个简单的文件作为多事务的案例（文件名为1.html）：

```
<html>
<body>
  <h1>image/<h1>
  <img src="2.png"/>
  <img src="3.png"/>
</body>
</html> 
```

即使如此简单的HTML文件，完全获取资源并呈现给客户也需要三个事务。这三个事务分别用来获取1.html、2.png、3.png文件。我们来看不同的事务处理模型应对此组请求有何不同。

## 一、并行连接

我们首先访问1.HTML，那么客户端会发送1个请求给服务器。首先获取1.html，是“打开连接、发送请求、获取响应、关闭”。

```
GET /1.html
```

然后获取2.png，依然是“打开连接、发送请求、获取响应、关闭”。 

```
GET /2.png
```

然后获取3.png，依然是“打开连接、发送请求、获取响应、关闭”。

```
GET /3.png
```

这样，为了获取3个文件，我们做了三次重复的连接打开和关闭过程。因为获取了1.html ,解析知道1.png和 2.png文件，之后可以不必分次序，而是同时打开两个连接，分别同时获取2个png资源，然后关闭。

然而，既然三个资源都在同一个服务器，请求也都来自一个客户端，是否可以重用既有的已经打开的连接呢？这样做是允许的，接下来的两种连接模型都是出于这样的优化目的而设计出来的。

## 二、keep-alive连接

keep-alive方法允许客户端和服务器暂时不关闭连接而继续用于接下来的事务。HTTP协议引入了Connection:keep-alive的首部字段，让双方都可以表达保持连接打开的意图。这样，上面的3个事务就变成了：

打开连接、发送请求、获取响应、但是不关闭：

```
GET /1.HTML 
Connection:keep-alive

HTTP/1.1 200 OK
Connection:keep-alive

内容…
```

然后获取2.png，“使用现有连接、发送请求、获取响应、也不关闭”。

```
GET /2.png
Connection:keep-alive

HTTP/1.1 200 OK
Connection:keep-alive

内容…
```

然后获取3.png，依然是“使用现有连接、发送请求、获取响应、关闭”。

```
GET /3.png

HTTP/1.1 200 OK

内容…
```

最后一条事务没有发送Connection:keep-alive，因此连接关闭。

使用keep-alive之后，效果就是后面的两个事务可以重用第一个事务建立的连接，从而省下两次打开和关闭连接的开销。











